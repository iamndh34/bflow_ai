{% load static i18n %}
<!-- Main Menu -->
<div data-simplebar class="nicescroll-bar">
    <div class="menu-content-wrap">
{#        <div class="menu-group mb-3">#}
{#            <ul class="navbar-nav flex-column">#}
{#                <li class="nav-item">#}
{#                    <a#}
{#                            class="nav-link" href="#"#}
{#                            data-bs-toggle="modal" data-bs-target="#modalSearchMenu"#}
{#                    >#}
{#                    <span class="nav-icon-wrap">#}
{#                        <span class="svg-icon menu-child-icon">#}
{#                            <i class="fa-solid fa-magnifying-glass"></i>#}
{#                        </span>#}
{#                    </span>#}
{#                        <span class="nav-link-text">{% trans 'Menu finder' %}</span>#}
{#                    </a>#}
{#                </li>#}
{#            </ul>#}
{#        </div>#}
        <div class="menu-group mb-3">
            <div class="nav-header">
                <span class="d-block mb-2">Spaces</span>
                <div
                                class="d-flex justify-content-center btn-group w-100"
                                id="menu-tenant"
                                data-space-selected="{{ base.space_current_detail.code }}"
                        >
                            <button
                                    id="menu-tenant-text"
                                    type="button" class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    data-dropdown-animation aria-haspopup="true" aria-expanded="false"
                            >
                                {% if base.space_current_detail.name %}
                                    {{ base.space_current_detail.icon|safe }} {{ base.space_current_detail.name }}
                                {% else %}
                                    _
                                {% endif %}
                            </button>
                            <div
                                    class="dropdown-menu w-230p border border-primary bg-smoke-light-5" data-url="{% url 'SpaceChangeView' %}"
                                    data-url-redirect="{% url 'HomeView' %}" data-method="PUT"
                            >
                                <div data-bs-spy="scroll" data-bs-smooth-scroll="true" class="h-400p position-relative overflow-y-scroll">
                                {% csrf_token %}
                                {% for item in base.space_list %}
                                    {% if item.child|length > 0 %}
                                        {% for item_child in item.child %}
                                            <a
                                                    class="dropdown-item space-item d-flex align-items-center gap-2 {% if base.space_current_detail.code == item_child.code %} text-primary {% endif %}"
                                                    data-space-code="{{ item_child.code }}"
                                                    data-space-name="{{ item_child.name }}"
                                                    href="#"
                                            >
                                                {{ item_child.icon|safe }}
                                                <span class="ml-1">{{ item_child.name }}</span>
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <a
                                                class="dropdown-item  {% if base.space_current_detail.code == item_child.code %} text-success {% endif %}"
                                                href="#"
                                        >{{ item.name }}</a>
                                    {% endif %}
                                {% endfor %}
                                </div>
                            </div>
                        </div>
            </div>
            <div class="ml-1">
                <ul class="navbar-nav flex-column">
                    <li class="nav-item">
                        <a
                                class="nav-link" href="#"
                                data-bs-toggle="modal" data-bs-target="#modalSearchMenu"
                        >
                        <span class="nav-icon-wrap">
                            <span class="svg-icon menu-child-icon">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </span>
                        </span>
                            <span class="nav-link-text">{% trans 'Menu finder' %}</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="menu-group">
            {% if base.menus and base.menus|length > 0 %}
                <div class="nav-header">
                    <span>{% trans 'Menus' %}</span>
                </div>
                <ul class="navbar-nav flex-column">

                    {% for item in base.menus %}
                        {% if item.child|length > 0 %}
                            <li class="nav-item">
                                <a
                                        class="nav-link d-flex align-items-center gap-2" href="javascript:void(0);" data-bs-toggle="collapse"
                                        data-bs-target="#{{ item.code }}"
                                        aria-expanded="{% if item.expanded %}true{% else %}false{% endif %}"
                                >
                                <span class="nav-icon-wrap d-flex align-items-center justify-content-center min-w-25p">
                                    <span class="svg-icon menu-child-icon">
                                        {{ item.icon|safe }}
                                    </span>
                                </span>
                                    <span class="nav-link-text">{% trans item.name %}</span>
                                </a>
                                <ul id="{{ item.code }}" class="nav flex-column collapse  nav-children {% if item.expanded %} show {% endif %}">
                                    <li class="nav-item">
                                        <ul class="nav flex-column">
                                            {% for child in item.child %}
                                                <li class="nav-item" id="{{ child.code }}">
                                                    <a class="nav-link d-flex align-items-center gap-2" href="{{ child.url }}">
                                                    <span class="nav-icon-wrap d-flex align-items-center justify-content-center min-w-25p">
                                                        <span class="svg-icon menu-child-icon">
                                                            {{ child.icon|safe }}
                                                        </span>
                                                    </span>
                                                        <span class="nav-link-text">
                                                        {% trans child.name %}
                                                    </span>
                                                    </a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        {% else %}
                            <li class="nav-item" id="{{ item.code }}">
                                <a class="nav-link d-flex align-items-center gap-2" href="{{ item.url }}">
                                <span class="nav-icon-wrap d-flex align-items-center justify-content-center min-w-25p">
                                    <span class="svg-icon menu-child-icon">
                                        {{ item.icon|safe }}
                                    </span>
                                </span>
                                    <span class="nav-link-text">{% trans item.name %}</span>
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <div class="mb-10"></div>
                <!-- // Test -->
            {% endif %}
        </div>
    </div>
</div>
<!-- /Main Menu -->

<div
        class="modal fade"
        id="modalSearchMenu" tabindex="-1" role="dialog" aria-labelledby="modalSearchMenu"
        data-bs-keyboard="true" data-bs-backdrop="static"
        data-url="{% url 'MenuFinder' %}"
>
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h5>{% trans 'Menu finder' %}</h5>
                    <p class="text-muted">{% trans 'Press esc to exit' %}</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div class="p-3">
                    <input type="text" class="form-control" placeholder="{% trans 'Enter your search text' %}"/>
                </div>
                <div class="w-100 d-flex min-h-200p" style="max-height: 500px;">
                    <div class="data-favorite p-3" style="flex: 1;overflow-y: auto;border-right: 1px solid #f1f1f1;"></div>
                    <div class="data-list p-3" style="flex: 1;overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const ele$ = $('#modalSearchMenu');
        const inp$ = ele$.find(':input');
        const data$ = ele$.find('.data-list');
        const dataFavorite$ = ele$.find('.data-favorite');

        let menusData = {};

        class MenuFavorite {
            static menusFavoriteData = [];

            static getFavorite() {
                if (localStorage) {
                    MenuFavorite.menusFavoriteData = JSON.parse(
                        localStorage.getItem('menu_favorite') ?? `[]`
                    );
                }
                return MenuFavorite.menusFavoriteData;
            }

            static hasInFavorite(item) {
                return MenuFavorite.menusFavoriteData.filter(itemChild => itemChild.url === item.url).length > 0;
            }

            static setFavorite(item) {
                if (localStorage) {
                    const exist = MenuFavorite.menusFavoriteData.filter(itemChild => itemChild.url === item.url);
                    if (exist.length === 0) {
                        MenuFavorite.menusFavoriteData.push(item);
                        localStorage.setItem('menu_favorite', JSON.stringify(MenuFavorite.menusFavoriteData));
                    }
                }
            }

            static removeFavorite(item) {
                if (localStorage) {
                    MenuFavorite.menusFavoriteData = MenuFavorite.menusFavoriteData.filter(itemChild => itemChild.url !== item.url);
                    localStorage.setItem('menu_favorite', JSON.stringify(MenuFavorite.menusFavoriteData));
                }
            }

            static render(searchTxt){
                const eleNew$ = renderChild(
                    searchTxt && searchTxt != "" ? MenuFavorite.menusFavoriteData.filter(
                        item => item.name.toLowerCase().indexOf(searchTxt) !== -1 || item.name_i18n.toLowerCase().indexOf(searchTxt) !== -1
                    ) : MenuFavorite.menusFavoriteData
                );
                dataFavorite$.empty().append(eleNew$);
            }
        }

        function removeVietnameseTones(str) {
            return str.normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // remove diacritics
                .replace(/đ/g, "d")
                .replace(/Đ/g, "D");
        }

        function searchMenus(data, keyword) {
            const result = {};

            const cleanKeyword = removeVietnameseTones(keyword.toLowerCase());

            function searchInMenu(menu) {
                return menu.filter(item => {
                    const name = removeVietnameseTones(item.name?.toLowerCase() || "");
                    const name_i18n = removeVietnameseTones(item.name_i18n?.toLowerCase() || "");

                    const isMatch = name.includes(cleanKeyword) || name_i18n.includes(cleanKeyword);

                    const matchingChildren = searchInMenu(item.child || []);
                    if (matchingChildren.length > 0) {
                        item.child = matchingChildren;
                    }

                    return isMatch || matchingChildren.length > 0;
                });
            }

            for (const key in data) {
                const filteredMenus = searchInMenu(data[key]);
                if (filteredMenus.length > 0) {
                    result[key] = filteredMenus;
                }
            }

            return result;
        }

        {#function searchMenus(data, keyword) {#}
        {#    const result = {};#}
        {##}
        {#    function searchInMenu(menu) {#}
        {#        const matchedMenus = menu.filter(item => {#}
        {#            const isMatch =#}
        {#                item.name.toLowerCase().includes(keyword.toLowerCase()) ||#}
        {#                item.name_i18n.toLowerCase().includes(keyword.toLowerCase());#}
        {##}
        {#            const matchingChildren = searchInMenu(item.child || []);#}
        {#            if (matchingChildren.length > 0) {#}
        {#                item.child = matchingChildren;#}
        {#                return true;#}
        {#            }#}
        {##}
        {#            return isMatch;#}
        {#        });#}
        {##}
        {#        return matchedMenus;#}
        {#    }#}
        {##}
        {#    for (const key in data) {#}
        {#        const filteredMenus = searchInMenu(data[key]);#}
        {#        if (filteredMenus.length > 0) {#}
        {#            result[key] = filteredMenus;#}
        {#        }#}
        {#    }#}
        {##}
        {#    return result;#}
        {#}#}

        function renderMenus(data) {
            data$.empty();
            Object.keys(data).map(
                key => {
                    const menusChild$ = renderChild(data[key]);
                    const tag$ = $(`<div class="w-100">${key.replaceAll("-", " ").toUpperCase()}</div>`).append(menusChild$);
                    data$.append(tag$);
                }
            )
        }

        function renderChild(dataList, marginLeft = 1) {
            const eleItemChild$ = $(`<div class="w-100" style="padding-left: ${marginLeft * 30}px"></div>`);
            dataList.map(
                item => {
                    let eleChild$ = $(``);
                    if (typeof item.url === 'string' && item.url.length > 0 && item.url !== '#') {
                        let star$ = '';
                        if (MenuFavorite.hasInFavorite(item)) {
                            star$ = $(`<span class="text-warning mr-3"><i class="fa-solid fa-star"></i></span>`);
                            star$.on('click', function () {
                                console.log('item:', item);
                                MenuFavorite.removeFavorite(item);
                                MenuFavorite.render();
                                renderMenus(menusData);
                            })
                        } else {
                            star$ = $(`<span class="text-light mr-3"><i class="fa-regular fa-star"></i></span>`);
                            star$.on('click', function () {
                                MenuFavorite.setFavorite(item);
                                MenuFavorite.render();
                                renderMenus(menusData);
                            })
                        }

                        eleChild$ = $(`<div class="w-100"></div>`).append(star$).append(`
                            <a href="${item.url}" class="w-100">
                                ${item.icon}
                                ${item.name_i18n}
                                <small class="text-light">${item.name}</small>
                            </a>
                        `);
                    } else {
                        eleChild$ = $(`
                            <div class="w-100">
                                ${item.icon}
                                ${item.name}
                            </div>
                        `);
                    }
                    let item$ = $(`<div class="w-100"></div>`);
                    eleChild$.attr('menuData', item);
                    item$.append(eleChild$);

                    if (item.child.length > 0) {
                        const child$ = renderChild(item.child, marginLeft + 1);
                        item$.append(child$);
                    }

                    eleItemChild$.append(item$);
                }
            );
            return eleItemChild$;
        }

        function renderSearch(txt) {
            data$.empty();
            if (txt && txt !== "") {
                const dataFiltered = searchMenus(menusData, txt);
                renderMenus(dataFiltered);
            } else {
                renderMenus(menusData);
            }
        }

        let keyDebouncing = null;
        inp$.on('input', function () {
            const txt = $(this).val();
            if (keyDebouncing) clearTimeout(keyDebouncing);
            keyDebouncing = setTimeout(
                () => {
                    renderSearch(txt);
                    MenuFavorite.render(txt);
                },
                300
            );
        })

        ele$.on('shown.bs.modal', function () {
            $.fn.callAjax2({
                url: ele$.data('url'),
                method: 'GET',
                isLoading: true,
                cache: true,
            }).then(
                resp => {
                    const data = $.fn.switcherResp(resp);
                    if (data && data.hasOwnProperty('menus')) {
                        MenuFavorite.getFavorite();
                        MenuFavorite.render();
                        menusData = data['menus'];
                        renderMenus(menusData);
                    }
                },
                errs => console.log(errs),
            )
        });
    })
</script>